# -*- coding: utf-8 -*-
"""perplexity.ipynb

Automatically generated by Colaboratory.

Original file is located at
    https://colab.research.google.com/drive/1IMnvqtjkDOvE_tt4dgPW2URLZuu9DImf
"""

!pip install -U nltk

import nltk
nltk.download('punkt')
nltk.download('wordnet')
import pandas as pd
from nltk.lm.preprocessing import padded_everygram_pipeline
from nltk.lm import MLE
from nltk.lm import Vocabulary
from nltk.translate import meteor_score

import os

def load():
  train_sentences = []
  for filename in os.listdir(os.path.expanduser('~/coca-samples-text')):
      if filename.endswith("txt"): 
          with open(filename) as f:
            train_sentences.extend(f.readlines())
  return train_sentences

def tokenise(train_sentences):
  tokenized_text = [list(map(str.lower, nltk.tokenize.word_tokenize(sent))) for sent in train_sentences]
  return tokenized_text

def train_fit(tokenized_text, test_sentences):
  n = 2
  train_data = [nltk.bigrams(t,  pad_right=True, pad_left=True, left_pad_symbol="<s>", right_pad_symbol="</s>") for t in tokenized_text]
  words = [word for sent in tokenized_text for word in sent]
  words.extend(["<s>", "</s>"])
  padded_vocab = Vocabulary(words)
  model = Laplace(n)
  model.fit(train_data, padded_vocab)
  tokenized_test = [list(map(str.lower, nltk.tokenize.word_tokenize(sent))) for sent in test_sentences]
  test_data = [nltk.bigrams(t,  pad_right=True, pad_left=True, left_pad_symbol="<s>", right_pad_symbol="</s>") for t in tokenized_test]
  tot = 0
  for i, test in enumerate(test_data):
    tot += model.perplexity(test)
  return(tot/len(test_data))

def perplexity_calc(test_data):
  train_sentences = load()
  tokenized_text - tokenise(train_sentences)
  test_sentences = pd.read_csv(test_data).summaries.tolist()
  perp = train_fit(tokenized_text, test_sentences)

def meteor(bart, t5):
  tot = 0
  for i in range(len(bart.summaries)):
    tot += nltk.translate.meteor_score.meteor_score(bart.summaries.tolist()[i], t5.summaries.tolist()[i])
  meteor = tot/len(bart.summaries)
  return meteor
